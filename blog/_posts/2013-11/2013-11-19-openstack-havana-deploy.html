---
layout: post
keywords: 
description: 
title: openstack havana all-in-one部署 
categories: [openstack]
tags: [openstack,havana]
group: archive
icon: compass
featured: false
---

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 部署环境</a></li>
<li><a href="#sec-2">2 初始网卡配置</a></li>
<li><a href="#sec-3">3 添加havana源</a></li>
<li><a href="#sec-4">4 安装mysql和rabbitmq</a></li>
<li><a href="#sec-5">5 安装和配置Keystone</a>
<ul>
<li><a href="#sec-5-1">5.1 安装</a></li>
<li><a href="#sec-5-2">5.2 删除默认keystone的sqlite db 文件</a></li>
<li><a href="#sec-5-3">5.3 创建数据库</a></li>
<li><a href="#sec-5-4">5.4 修改配置文件</a>
<ul>
<li><a href="#sec-5-4-1">5.4.1 修改/etc/keystone/keystone.conf</a></li>
<li><a href="#sec-5-4-2">5.4.2 同步keystone表数据到db中并重启keystone</a></li>
</ul>
</li>
<li><a href="#sec-5-5">5.5 创建tenant、user、roles</a>
<ul>
<li><a href="#sec-5-5-1">5.5.1 首先创建两个环境变量</a></li>
<li><a href="#sec-5-5-2">5.5.2 创建admin和service两个租户</a></li>
<li><a href="#sec-5-5-3">5.5.3 创建用户admin，密码password</a></li>
<li><a href="#sec-5-5-4">5.5.4 创建角色admin</a></li>
<li><a href="#sec-5-5-5">5.5.5 关联用户、角色、租户</a></li>
</ul>
</li>
<li><a href="#sec-5-6">5.6 创建Services 及 API endpoints</a></li>
<li><a href="#sec-5-7">5.7 验证认证服务(Keystone)安装是否成功</a></li>
</ul>
</li>
<li><a href="#sec-6">6 安装和配置glance</a>
<ul>
<li><a href="#sec-6-1">6.1 安装</a></li>
<li><a href="#sec-6-2">6.2 创建 glance 数据库</a></li>
<li><a href="#sec-6-3">6.3 修改glance配置文件</a></li>
<li><a href="#sec-6-4">6.4 同步数据库</a></li>
<li><a href="#sec-6-5">6.5 创建名为glance的认证用户</a></li>
<li><a href="#sec-6-6">6.6 创建service服务和endpoint</a></li>
<li><a href="#sec-6-7">6.7 重启glance服务</a></li>
<li><a href="#sec-6-8">6.8 上传镜像</a></li>
</ul>
</li>
<li><a href="#sec-7">7 安装和配置nova</a>
<ul>
<li><a href="#sec-7-1">7.1 安装计算服务</a></li>
<li><a href="#sec-7-2">7.2 修复guestfs的一个bug</a></li>
<li><a href="#sec-7-3">7.3 删除默认nova的sqlite db文件</a></li>
<li><a href="#sec-7-4">7.4 创建数据库</a></li>
<li><a href="#sec-7-5">7.5 修改配置文件</a></li>
<li><a href="#sec-7-6">7.6 创建用户与角色</a></li>
<li><a href="#sec-7-7">7.7 创建service服务和endpoint</a></li>
<li><a href="#sec-7-8">7.8 重启nova服务</a></li>
</ul>
</li>
<li><a href="#sec-8">8 Block Storage (Cinder)安装</a>
<ul>
<li><a href="#sec-8-1">8.1 安装服务</a></li>
<li><a href="#sec-8-2">8.2 创建数据库</a></li>
<li><a href="#sec-8-3">8.3 建立一个逻辑卷卷组 cinder-volumes</a></li>
<li><a href="#sec-8-4">8.4 修改配置文件</a></li>
<li><a href="#sec-8-5">8.5 创建用户，角色，服务和endpoint</a></li>
<li><a href="#sec-8-6">8.6 同步数据并重启服务</a></li>
<li><a href="#sec-8-7">8.7 检查</a></li>
</ul>
</li>
<li><a href="#sec-9">9 安装和配置neutron</a>
<ul>
<li><a href="#sec-9-1">9.1 创建数据库</a></li>
<li><a href="#sec-9-2">9.2 创建用户，服务和endpoint</a></li>
<li><a href="#sec-9-3">9.3 安装网络服务</a>
<ul>
<li><a href="#sec-9-3-1">9.3.1 安装neutron组件</a></li>
<li><a href="#sec-9-3-2">9.3.2 打开ip_forward</a></li>
<li><a href="#sec-9-3-3">9.3.3 编辑配置文件</a></li>
</ul>
</li>
<li><a href="#sec-9-4">9.4 安装ovs插件</a>
<ul>
<li><a href="#sec-9-4-1">9.4.1 安装</a></li>
<li><a href="#sec-9-4-2">9.4.2 网络配置</a>
<ul>
<li><a href="#sec-9-4-2-1">9.4.2.1 建立网桥</a></li>
<li><a href="#sec-9-4-2-2">9.4.2.2 编辑配置/etc/network/interfaces</a></li>
</ul>
</li>
<li><a href="#sec-9-4-3">9.4.3 编辑配置文件</a></li>
</ul>
</li>
<li><a href="#sec-9-5">9.5 重启服务</a></li>
</ul>
</li>
<li><a href="#sec-10">10 Orchestration Server(Heat)安装</a>
<ul>
<li><a href="#sec-10-1">10.1 安装</a></li>
<li><a href="#sec-10-2">10.2 创建数据库</a></li>
<li><a href="#sec-10-3">10.3 编辑配置文件</a></li>
<li><a href="#sec-10-4">10.4 同步数据</a></li>
<li><a href="#sec-10-5">10.5 创建用户和角色</a></li>
<li><a href="#sec-10-6">10.6 创建服务和endpoint</a></li>
<li><a href="#sec-10-7">10.7 重启服务</a></li>
<li><a href="#sec-10-8">10.8 创建openrc</a></li>
<li><a href="#sec-10-9">10.9 创建和管理stacks</a></li>
</ul>
</li>
<li><a href="#sec-11">11 Metering/Monitoring Server（Ceilometer）安装</a>
<ul>
<li><a href="#sec-11-1">11.1 安装</a></li>
<li><a href="#sec-11-2">11.2 创建数据库</a></li>
<li><a href="#sec-11-3">11.3 修改配置文件</a></li>
<li><a href="#sec-11-4">11.4 创建用户，角色，服务和endpoint</a></li>
<li><a href="#sec-11-5">11.5 重启服务</a></li>
</ul>
</li>
<li><a href="#sec-12">12 安装horizon</a></li>
<li><a href="#sec-13">13 参考资料</a>
<ul>
<li><a href="#sec-13-1">13.1 heat</a></li>
</ul>
</li>
<li><a href="#sec-14">14 其他</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">部署环境</h2>
<div class="outline-text-2" id="text-1">

<p>64位ubuntu-12.04.3-server系统 <br/>
双网卡
</p><ul>
<li>外网eth0 192.168.150.9/24
</li>
<li>内网eth1 172.16.0.254/24
</li>
</ul>

<p>双硬盘
</p></div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">初始网卡配置</h2>
<div class="outline-text-2" id="text-2">

<p>为eth0和eth1配置IP
</p>


<pre class="src src-sh"><span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">cat /etc/network/interfaces</span>
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 192.168.150.9
netmask 255.255.255.0
gateway 192.168.150.1
dns-nameservers 8.8.8.8

auto eth1
iface eth1 inet static
        address 172.16.0.254
        netmask 255.255.255.0
</pre>

<p>
重启网络
</p>


<pre class="src src-sh">/etc/init.d/networking restart
</pre>

</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">添加havana源</h2>
<div class="outline-text-2" id="text-3">




<pre class="src src-sh">apt-get install python-software-properties
add-apt-repository cloud-archive:havana
apt-get update &amp;&amp; apt-get dist-upgrade
</pre>

</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">安装mysql和rabbitmq</h2>
<div class="outline-text-2" id="text-4">




<pre class="src src-sh"><span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">&#35774;&#32622;mysql root&#29992;&#25143;&#23494;&#30721;&#20026;123456</span>
<span style="color: #cd6600;">echo</span> mysql-server-5.5 mysql-server/root_password password 123456 | debconf-set-selections
<span style="color: #cd6600;">echo</span> mysql-server-5.5 mysql-server/root_password_again password 123456 | debconf-set-selections
apt-get -y install mysql-server python-mysqldb
<span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">&#20801;&#35768;&#22806;&#37096;&#35775;&#38382;mysql</span>
sed -i -e  <span style="color: #8b7355;">"s/^\(bind-address\s*=\).*/\1 0.0.0.0/"</span> /etc/mysql/my.cnf
<span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">&#37325;&#21551;mysql&#26381;&#21153;</span>
/etc/init.d/mysql restart
apt-get -y install rabbitmq-server
</pre>

<p>
rabbitmq-server默认会创建一个用户，用户名密码均为guest，并允许任何人用guest用户和默认密码访问RabbitMQ server。
修改guest密码的命令
</p>


<pre class="src src-sh">rabbitmqctl change_password guest NEW_PASS
</pre>

</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5">安装和配置Keystone</h2>
<div class="outline-text-2" id="text-5">


</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1">安装</h3>
<div class="outline-text-3" id="text-5-1">




<pre class="src src-sh">apt-get install -y keystone
</pre>

</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2">删除默认keystone的sqlite db 文件</h3>
<div class="outline-text-3" id="text-5-2">




<pre class="src src-sh">rm -f /var/lib/keystone/keystone.db
</pre>

</div>

</div>

<div id="outline-container-5-3" class="outline-3">
<h3 id="sec-5-3">创建数据库</h3>
<div class="outline-text-3" id="text-5-3">

<p>用户名和密码均为keystone
</p>


<pre class="src src-sh"><span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">mysql -u root -p123456</span>
mysql&gt; CREATE DATABASE keystone;
mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO <span style="color: #8b7355;">'keystone'</span>@<span style="color: #8b7355;">'localhost'</span> IDENTIFIED BY <span style="color: #8b7355;">'keystone'</span>;
mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO <span style="color: #8b7355;">'keystone'</span>@<span style="color: #8b7355;">'%'</span> IDENTIFIED BY <span style="color: #8b7355;">'keystone'</span>;
</pre>

</div>

</div>

<div id="outline-container-5-4" class="outline-3">
<h3 id="sec-5-4">修改配置文件</h3>
<div class="outline-text-3" id="text-5-4">


</div>

<div id="outline-container-5-4-1" class="outline-4">
<h4 id="sec-5-4-1">修改/etc/keystone/keystone.conf</h4>
<div class="outline-text-4" id="text-5-4-1">

<p>修改[DEFAULT]admin_token值， 修改[sql]的connection.
</p>


<pre class="src src-sh">[DEFAULT]
admin_token = wchunx
...
[sql]
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">The SQLAlchemy connection string used to connect to the database</span>
connection = mysql://keystone:keystone@172.16.0.254/keystone
...
</pre>

</div>

</div>

<div id="outline-container-5-4-2" class="outline-4">
<h4 id="sec-5-4-2">同步keystone表数据到db中并重启keystone</h4>
<div class="outline-text-4" id="text-5-4-2">




<pre class="src src-sh">keystone-manage db_sync
/etc/init.d/keystone restart
</pre>

</div>
</div>

</div>

<div id="outline-container-5-5" class="outline-3">
<h3 id="sec-5-5">创建tenant、user、roles</h3>
<div class="outline-text-3" id="text-5-5">


</div>

<div id="outline-container-5-5-1" class="outline-4">
<h4 id="sec-5-5-1">首先创建两个环境变量</h4>
<div class="outline-text-4" id="text-5-5-1">




<pre class="src src-sh"><span style="color: #cd6600;">export</span> <span style="color: #2e8b57;">OS_SERVICE_TOKEN</span>=wchunx
<span style="color: #cd6600;">export</span> <span style="color: #2e8b57;">OS_SERVICE_ENDPOINT</span>=http://172.16.0.254:35357/v2.0
</pre>

</div>

</div>

<div id="outline-container-5-5-2" class="outline-4">
<h4 id="sec-5-5-2">创建admin和service两个租户</h4>
<div class="outline-text-4" id="text-5-5-2">




<pre class="src src-sh">keystone tenant-create --name=admin --description=<span style="color: #8b7355;">"Admin Tenant"</span>
keystone tenant-create --name=service --description=<span style="color: #8b7355;">"Service Tenant"</span>
</pre>

</div>

</div>

<div id="outline-container-5-5-3" class="outline-4">
<h4 id="sec-5-5-3">创建用户admin，密码password</h4>
<div class="outline-text-4" id="text-5-5-3">




<pre class="src src-sh">keystone user-create --name=admin --pass=password --email=admin@126.com
</pre>

</div>

</div>

<div id="outline-container-5-5-4" class="outline-4">
<h4 id="sec-5-5-4">创建角色admin</h4>
<div class="outline-text-4" id="text-5-5-4">




<pre class="src src-sh">keystone role-create --name=admin
</pre>

</div>

</div>

<div id="outline-container-5-5-5" class="outline-4">
<h4 id="sec-5-5-5">关联用户、角色、租户</h4>
<div class="outline-text-4" id="text-5-5-5">




<pre class="src src-sh">keystone user-role-add --user=admin --tenant=admin --role=admin
</pre>

</div>
</div>

</div>

<div id="outline-container-5-6" class="outline-3">
<h3 id="sec-5-6">创建Services 及 API endpoints</h3>
<div class="outline-text-3" id="text-5-6">

<p>首先创建一个类型为identity的keystone服务，名称为keystone：
</p>


<pre class="src src-sh">keystone service-create --name=keystone --type=identity --description=<span style="color: #8b7355;">"Keystone Identity Service"</span>
</pre>

<p>
记下server id,创建endpoint会用到。后面创建server和endpoint也是如此。<br/>
创建endpoint,命令中的the_service_id_above用上步产生的server id替换。
</p>


<pre class="src src-sh">keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:5000/v2.0 <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:5000/v2.0 <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.0.254:35357/v2.0
</pre>

</div>

</div>

<div id="outline-container-5-7" class="outline-3">
<h3 id="sec-5-7">验证认证服务(Keystone)安装是否成功</h3>
<div class="outline-text-3" id="text-5-7">

<p>先unset之前的环境变量：
</p>


<pre class="src src-sh"><span style="color: #cd6600;">unset</span> OS_SERVICE_TOKEN OS_SERVICE_ENDPOINT
</pre>

<p>
创建keystonerc文件(环境变量)
</p>


<pre class="src src-sh">cat &gt; /root/keystonerc &lt;&lt; _EOF_
<span style="color: #ffa54f;">export OS_USERNAME=admin</span>
<span style="color: #ffa54f;">export OS_PASSWORD=password</span>
<span style="color: #ffa54f;">export OS_TENANT_NAME=admin</span>
<span style="color: #ffa54f;">export OS_AUTH_URL=http://172.16.0.254:35357/v2.0</span>
<span style="color: #ffa54f;">_EOF_</span>
<span style="color: #cd6600;">echo</span> <span style="color: #8b7355;">'source /root/keystonerc'</span> &gt;&gt; /root/.bashrc
<span style="color: #cd6600;">source</span> /root/keystonerc
</pre>

<p>
验证keystone是否正常
</p>


<pre class="src src-sh">keystone token-get
keystone user-list
keystone role-list
keystone tenant-list
keystone endpoint-list
</pre>

</div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6">安装和配置glance</h2>
<div class="outline-text-2" id="text-6">


</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1">安装</h3>
<div class="outline-text-3" id="text-6-1">




<pre class="src src-sh">apt-get install glance
</pre>

<p>
删除 glance sqlite 文件：
</p>


<pre class="src src-sh">rm -f /var/lib/glance/glance.sqlite
</pre>

</div>

</div>

<div id="outline-container-6-2" class="outline-3">
<h3 id="sec-6-2">创建 glance 数据库</h3>
<div class="outline-text-3" id="text-6-2">

<p>用户名密码均为glance
</p>


<pre class="src src-sh">mysql -u root -p123456
mysql&gt; CREATE DATABASE glance;
mysql&gt; GRANT ALL PRIVILEGES ON glance.* TO <span style="color: #8b7355;">'glance'</span>@<span style="color: #8b7355;">'localhost'</span> IDENTIFIED BY <span style="color: #8b7355;">'glance'</span>;
mysql&gt; GRANT ALL PRIVILEGES ON glance.* TO <span style="color: #8b7355;">'glance'</span>@<span style="color: #8b7355;">'%'</span> IDENTIFIED BY <span style="color: #8b7355;">'glance'</span>;
</pre>

</div>

</div>

<div id="outline-container-6-3" class="outline-3">
<h3 id="sec-6-3">修改glance配置文件</h3>
<div class="outline-text-3" id="text-6-3">

<p>修改/etc/glance/glance-api.conf
</p>


<pre class="src src-sh">verbose = True
debug = True
sql_connection = mysql://glance:glance@172.16.0.254/glance
[keystone_authtoken]
auth_host = 172.16.0.254
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = glance
admin_password = glance
notifier_strategy = rabbit
</pre>

<p>
修改/etc/glance/glance-registry.conf
</p>


<pre class="src src-sh">verbose = True
debug = True
sql_connection = mysql://glance:glance@172.16.0.254/glance
[keystone_authtoken]
auth_host = 172.16.0.254
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = glance
admin_password = glance
</pre>

<p>
/etc/glance/glance-api-paste.ini
</p>


<pre class="src src-sh">[filter:authtoken]
paste.filter_factory=keystoneclient.middleware.auth_token:filter_factory
<span style="color: #2e8b57;">auth_host</span>=172.16.0.254
<span style="color: #2e8b57;">admin_user</span>=glance
<span style="color: #2e8b57;">admin_tenant_name</span>=service
<span style="color: #2e8b57;">admin_password</span>=glance
</pre>

<p>
/etc/glance/glance-registry-paste.ini
</p>


<pre class="src src-sh">[filter:authtoken]
paste.filter_factory=keystoneclient.middleware.auth_token:filter_factory
<span style="color: #2e8b57;">auth_host</span>=172.16.0.254
<span style="color: #2e8b57;">admin_user</span>=glance
<span style="color: #2e8b57;">admin_tenant_name</span>=service
<span style="color: #2e8b57;">admin_password</span>=glance
</pre>

</div>

</div>

<div id="outline-container-6-4" class="outline-3">
<h3 id="sec-6-4">同步数据库</h3>
<div class="outline-text-3" id="text-6-4">




<pre class="src src-sh">glance-manage db_sync
</pre>

</div>

</div>

<div id="outline-container-6-5" class="outline-3">
<h3 id="sec-6-5">创建名为glance的认证用户</h3>
<div class="outline-text-3" id="text-6-5">




<pre class="src src-sh">keystone user-create --name=glance --pass=glance --email=glance@126.com
keystone user-role-add --user=glance --tenant=service --role=admin
</pre>

</div>

</div>

<div id="outline-container-6-6" class="outline-3">
<h3 id="sec-6-6">创建service服务和endpoint</h3>
<div class="outline-text-3" id="text-6-6">




<pre class="src src-sh">keystone service-create --name=glance --type=image --description=<span style="color: #8b7355;">"Glance Image Service"</span>

keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:9292 <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:9292 <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.0.254:9292
</pre>

</div>

</div>

<div id="outline-container-6-7" class="outline-3">
<h3 id="sec-6-7">重启glance服务</h3>
<div class="outline-text-3" id="text-6-7">




<pre class="src src-sh">service glance-registry restart
service glance-api restart
</pre>

</div>

</div>

<div id="outline-container-6-8" class="outline-3">
<h3 id="sec-6-8">上传镜像</h3>
<div class="outline-text-3" id="text-6-8">

<p>下载测试镜像
</p>


<pre class="src src-sh">wget http://cdn.download.cirros-cloud.net/0.3.1/cirros-0.3.1-x86_64-disk.img
</pre>

<p>
上传
</p>


<pre class="src src-sh">glance image-create --name=<span style="color: #8b7355;">'cirros'</span> --is-public true --container-format bare --disk-format qcow2 &lt; ./cirros-0.3.0-x86_64-disk.img
</pre>

<p>
查看上传的镜像
</p>


<pre class="src src-sh">glance image-list
</pre>

</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7">安装和配置nova</h2>
<div class="outline-text-2" id="text-7">


</div>

<div id="outline-container-7-1" class="outline-3">
<h3 id="sec-7-1">安装计算服务</h3>
<div class="outline-text-3" id="text-7-1">




<pre class="src src-sh">apt-get install nova-novncproxy novnc nova-api python-novaclient <span style="color: #8b7355;">\</span>
nova-ajax-console-proxy nova-cert nova-conductor <span style="color: #8b7355;">\</span>
nova-consoleauth nova-doc nova-scheduler
apt-get install nova-compute-kvm python-guestfs
</pre>

<p>
安装过程会提示你,选择”yes”即可。
</p></div>

</div>

<div id="outline-container-7-2" class="outline-3">
<h3 id="sec-7-2">修复guestfs的一个bug</h3>
<div class="outline-text-3" id="text-7-2">




<pre class="src src-sh">chmod 0644 /boot/vmlinuz*
</pre>

</div>

</div>

<div id="outline-container-7-3" class="outline-3">
<h3 id="sec-7-3">删除默认nova的sqlite db文件</h3>
<div class="outline-text-3" id="text-7-3">




<pre class="src src-sh">rm -f /var/lib/nova/nova.sqlite
</pre>

</div>

</div>

<div id="outline-container-7-4" class="outline-3">
<h3 id="sec-7-4">创建数据库</h3>
<div class="outline-text-3" id="text-7-4">




<pre class="src src-sh">mysql -u root -p123456
mysql&gt; CREATE DATABASE nova;
mysql&gt; GRANT ALL PRIVILEGES ON nova.* TO <span style="color: #8b7355;">'nova'</span>@<span style="color: #8b7355;">'localhost'</span> IDENTIFIED BY <span style="color: #8b7355;">'nova'</span>;
mysql&gt; GRANT ALL PRIVILEGES ON nova.* TO <span style="color: #8b7355;">'nova'</span>@<span style="color: #8b7355;">'%'</span> IDENTIFIED BY <span style="color: #8b7355;">'nova'</span>;
</pre>

</div>

</div>

<div id="outline-container-7-5" class="outline-3">
<h3 id="sec-7-5">修改配置文件</h3>
<div class="outline-text-3" id="text-7-5">

<p>修改/etc/nova/nova.conf，原有基础上添加
</p>


<pre class="src src-sh">[DEFAULT]
<span style="color: #2e8b57;">my_ip</span>=192.168.150.8
<span style="color: #2e8b57;">vncserver_listen</span>=0.0.0.0
<span style="color: #2e8b57;">vncserver_proxyclient_address</span>=172.16.0.254
<span style="color: #2e8b57;">novncproxy_base_url</span>=http://192.168.150.8:6080/vnc_auto.html
<span style="color: #2e8b57;">auth_strategy</span>=keystone
rpc_backend = nova.rpc.impl_kombu
rabbit_host = 172.16.0.254
glance_host = 172.16.0.254

neutron_metadata_proxy_shared_secret = wchunx
service_neutron_metadata_proxy = true

<span style="color: #2e8b57;">instance_usage_audit</span>=True
<span style="color: #2e8b57;">instance_usage_audit_period</span>=hour
<span style="color: #2e8b57;">notify_on_state_change</span>=vm_and_task_state
<span style="color: #2e8b57;">notification_driver</span>=nova.openstack.common.notifier.rpc_notifier
<span style="color: #2e8b57;">notification_driver</span>=ceilometer.compute.nova_notifier
[database]
connection = mysql://nova:nova@172.16.0.254/nova

<span style="color: #2e8b57;">network_api_class</span>=nova.network.neutronv2.api.API
<span style="color: #2e8b57;">neutron_url</span>=http://172.16.0.254:9696
<span style="color: #2e8b57;">neutron_auth_strategy</span>=keystone
<span style="color: #2e8b57;">neutron_admin_tenant_name</span>=service
<span style="color: #2e8b57;">neutron_admin_username</span>=neutron
<span style="color: #2e8b57;">neutron_admin_password</span>=neutron
<span style="color: #2e8b57;">neutron_admin_auth_url</span>=http://172.16.0.254:35357/v2.0
<span style="color: #2e8b57;">firewall_driver</span>=nova.virt.firewall.NoopFirewallDriver
<span style="color: #2e8b57;">security_group_api</span>=neutron
</pre>

<p>
修改/etc/nova/api-paste.ini的[filter:authtoken]部分
</p>


<pre class="src src-sh">[filter:authtoken]
paste.filter_factory=keystoneclient.middleware.auth_token:filter_factory
<span style="color: #2e8b57;">auth_host</span>=172.16.0.254
auth_port = 35357
auth_protocol = http
<span style="color: #2e8b57;">auth_uri</span>=http://172.16.0.254:5000
<span style="color: #2e8b57;">admin_tenant_name</span>=service
<span style="color: #2e8b57;">admin_user</span>=nova
<span style="color: #2e8b57;">admin_password</span>=nova
</pre>

</div>

</div>

<div id="outline-container-7-6" class="outline-3">
<h3 id="sec-7-6">创建用户与角色</h3>
<div class="outline-text-3" id="text-7-6">




<pre class="src src-sh">keystone user-create --name=nova --pass=nova --email=nova@126.com
keystone user-role-add --user=nova --tenant=service --role=admin
</pre>

</div>

</div>

<div id="outline-container-7-7" class="outline-3">
<h3 id="sec-7-7">创建service服务和endpoint</h3>
<div class="outline-text-3" id="text-7-7">




<pre class="src src-sh">keystone service-create --name=nova --type=compute --description=<span style="color: #8b7355;">"Nova Compute service"</span>

keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:8774/v2/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:8774/v2/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.0.254:8774/v2/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s
</pre>

</div>

</div>

<div id="outline-container-7-8" class="outline-3">
<h3 id="sec-7-8">重启nova服务</h3>
<div class="outline-text-3" id="text-7-8">

<p>同步数据
</p>


<pre class="src src-sh">nova-manage db sync
</pre>

<p>
重启服务
</p>


<pre class="src src-sh"><span style="color: #cd6600;">cd</span> /etc/init.d/; <span style="color: #1c86ee;">for</span> i<span style="color: #1c86ee;"> in</span> $( ls nova-* ); <span style="color: #1c86ee;">do</span> sudo service $<span style="color: #2e8b57;">i</span> restart; <span style="color: #1c86ee;">done</span>
</pre>

<p>
测试nova是否安装正常
</p>


<pre class="src src-sh">nova image-list
</pre>

</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8">Block Storage (Cinder)安装</h2>
<div class="outline-text-2" id="text-8">


</div>

<div id="outline-container-8-1" class="outline-3">
<h3 id="sec-8-1">安装服务</h3>
<div class="outline-text-3" id="text-8-1">




<pre class="src src-sh">apt-get install cinder-api cinder-scheduler
</pre>

</div>

</div>

<div id="outline-container-8-2" class="outline-3">
<h3 id="sec-8-2">创建数据库</h3>
<div class="outline-text-3" id="text-8-2">




<pre class="src src-sh">mysql -u root -p123456
mysql&gt; CREATE DATABASE cinder;
mysql&gt; GRANT ALL PRIVILEGES ON cinder.* TO <span style="color: #8b7355;">'cinder'</span>@<span style="color: #8b7355;">'localhost'</span> IDENTIFIED BY <span style="color: #8b7355;">'cinder'</span>;
mysql&gt; GRANT ALL PRIVILEGES ON cinder.* TO <span style="color: #8b7355;">'cinder'</span>@<span style="color: #8b7355;">'%'</span> IDENTIFIED BY <span style="color: #8b7355;">'cinder'</span>;
</pre>

</div>

</div>

<div id="outline-container-8-3" class="outline-3">
<h3 id="sec-8-3">建立一个逻辑卷卷组 cinder-volumes</h3>
<div class="outline-text-3" id="text-8-3">

<p>创建一个普通分区，我这里用的sdb，创建了一个主分区，大小为所有空间
</p>


<pre class="src src-sh">apt-get install cinder-volume lvm2
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">fdisk /dev/sdb</span>
n
p
1
Enter
Enter
t
8e
w
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">pvcreate /dev/sdb1</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">vgcreate cinder-volumes /dev/sdb1</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">vgs</span>
  VG             <span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">PV #LV #SN Attr   VSize   VFree</span>
  cinder-volumes   1   0   0 wz--n- 150.00g 150.00g
  localhost        1   2   0 wz--n- 279.12g  12.00m
</pre>

</div>

</div>

<div id="outline-container-8-4" class="outline-3">
<h3 id="sec-8-4">修改配置文件</h3>
<div class="outline-text-3" id="text-8-4">

<p>/etc/cinder/cinder.conf
</p>


<pre class="src src-sh">[database]
...
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">The SQLAlchemy connection string used to connect to the</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">database (string value)</span>
connection = mysql://cinder:cinder@172.16.0.254/cinder
...
notification_driver = cinder.openstack.common.notifier.rabbit_notifier
control_exchange = cinder
</pre>

<p>
/etc/cinder/api-paste.ini
</p>


<pre class="src src-sh">[filter:authtoken]
paste.filter_factory=keystoneclient.middleware.auth_token:filter_factory
<span style="color: #2e8b57;">auth_host</span>=172.16.0.254
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = cinder
admin_password = cinder
</pre>

</div>

</div>

<div id="outline-container-8-5" class="outline-3">
<h3 id="sec-8-5">创建用户，角色，服务和endpoint</h3>
<div class="outline-text-3" id="text-8-5">




<pre class="src src-sh">keystone user-create --name=cinder --pass=cinder --email=cinder@126.com
keystone user-role-add --user=cinder --tenant=service --role=admin

keystone service-create --name=cinder --type=volume --description=<span style="color: #8b7355;">"Cinder Volume Service"</span>
keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:8776/v1/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:8776/v1/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.0.254:8776/v1/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s

keystone service-create --name=cinder --type=volumev2 --description=<span style="color: #8b7355;">"Cinder Volume Service V2"</span>
keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:8776/v2/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:8776/v2/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.0.254:8776/v2/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s
</pre>

</div>

</div>

<div id="outline-container-8-6" class="outline-3">
<h3 id="sec-8-6">同步数据并重启服务</h3>
<div class="outline-text-3" id="text-8-6">




<pre class="src src-sh">cinder-manage db sync
service cinder-scheduler restart
service cinder-api restart
</pre>

</div>

</div>

<div id="outline-container-8-7" class="outline-3">
<h3 id="sec-8-7">检查</h3>
<div class="outline-text-3" id="text-8-7">




<pre class="src src-sh">cinder list
</pre>

</div>
</div>

</div>

<div id="outline-container-9" class="outline-2">
<h2 id="sec-9">安装和配置neutron</h2>
<div class="outline-text-2" id="text-9">


</div>

<div id="outline-container-9-1" class="outline-3">
<h3 id="sec-9-1">创建数据库</h3>
<div class="outline-text-3" id="text-9-1">




<pre class="src src-sh">mysql -u root -p123456
mysql&gt; CREATE DATABASE neutron;
mysql&gt; GRANT ALL PRIVILEGES ON neutron.* TO <span style="color: #8b7355;">'neutron'</span>@<span style="color: #8b7355;">'localhost'</span> IDENTIFIED BY <span style="color: #8b7355;">'neutron'</span>;
mysql&gt; GRANT ALL PRIVILEGES ON neutron.* TO <span style="color: #8b7355;">'neutron'</span>@<span style="color: #8b7355;">'%'</span> IDENTIFIED BY <span style="color: #8b7355;">'neutron'</span>;
</pre>

</div>

</div>

<div id="outline-container-9-2" class="outline-3">
<h3 id="sec-9-2">创建用户，服务和endpoint</h3>
<div class="outline-text-3" id="text-9-2">




<pre class="src src-sh">keystone user-create --name=neutron --pass=neutron --email=neutron@126.com
keystone user-role-add --user=neutron --tenant=service --role=admin

keystone service-create --name=neutron --type=network --description=<span style="color: #8b7355;">"OpenStack Networking Service"</span>
keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl http://172.16.0.254:9696 <span style="color: #8b7355;">\</span>
--adminurl http://172.16.0.254:9696 <span style="color: #8b7355;">\</span>
--internalurl http://172.16.0.254:9696
</pre>

</div>

</div>

<div id="outline-container-9-3" class="outline-3">
<h3 id="sec-9-3">安装网络服务</h3>
<div class="outline-text-3" id="text-9-3">


</div>

<div id="outline-container-9-3-1" class="outline-4">
<h4 id="sec-9-3-1">安装neutron组件</h4>
<div class="outline-text-4" id="text-9-3-1">




<pre class="src src-sh">apt-get install neutron-server neutron-dhcp-agent  neutron-l3-agent neutron-lbaas-agent
</pre>

</div>

</div>

<div id="outline-container-9-3-2" class="outline-4">
<h4 id="sec-9-3-2">打开ip_forward</h4>
<div class="outline-text-4" id="text-9-3-2">

<p>编辑/etc/sysctl.conf
</p>


<pre class="src src-sh">net.ipv4.ip_forward=1
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
</pre>

<p>
重启网络
</p>


<pre class="src src-sh">sysctl -p
/etc/init.d/networking restart
</pre>

</div>

</div>

<div id="outline-container-9-3-3" class="outline-4">
<h4 id="sec-9-3-3">编辑配置文件</h4>
<div class="outline-text-4" id="text-9-3-3">

<p>编辑/etc/neutron/neutron.conf 
</p>


<pre class="src src-sh">[DEFAULT]
debug = True
verbose = True
[database]
connection = mysql://neutron:neutron@172.16.0.254/neutron
core_plugin = neutron.plugins.openvswitch.ovs_neutron_plugin.OVSNeutronPluginV2
service_plugins = neutron.plugins.services.agent_loadbalancer.plugin.LoadBalancerPlugin
service_plugins = neutron.services.firewall.fwaas_plugin.FirewallPlugin

[keystone_authtoken]
auth_host = 172.16.0.254
auth_port = 35357
auth_url = http://172.16.0.254:35357/v2.0
auth_strategy = keystone
auth_protocol = http
admin_tenant_name = service
admin_user = neutron
admin_password = neutron
</pre>

<p>
编辑/etc/neutron/api-paste.ini
</p>


<pre class="src src-sh">[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
<span style="color: #2e8b57;">auth_host</span>=172.16.0.254
<span style="color: #2e8b57;">auth_uri</span>=http://172.16.0.254:5000
<span style="color: #2e8b57;">admin_user</span>=neutron
<span style="color: #2e8b57;">admin_tenant_name</span>=service
<span style="color: #2e8b57;">admin_password</span>=neutron
</pre>

<p>
编辑/etc/neutron/dhcp_agent.ini
</p>


<pre class="src src-sh">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
ovs_use_veth = True
enable_isolated_metadata = True
use_namespaces = True
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</pre>

<p>
编辑/etc/neutron/l3_agent.ini
</p>


<pre class="src src-sh">auth_url = http://172.16.0.254:35357/v2.0
admin_tenant_name = service
admin_user = neutron
admin_password = neutron
metadata_ip = 172.16.0.254
use_namespaces = True
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
</pre>

<p>
编辑/etc/neutron/metadata_agent.ini
</p>


<pre class="src src-sh">[DEFAULT]
auth_url = http://172.16.0.254:5000/v2.0
admin_tenant_name = service
admin_user = neutron
admin_password = neutron
nova_metadata_ip = 172.16.0.254
metadata_proxy_shared_secret = wchunx
</pre>

<p>
编辑/etc/neutron/lbaas_agent.ini
</p>


<pre class="src src-sh">interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
device_driver = neutron.services.loadbalancer.drivers.haproxy.namespace_driver.HaproxyNSDriver
</pre>

<p>
创建/etc/neutron/fwaas_driver.ini
</p>


<pre class="src src-sh">[fwaas]
driver = neutron.services.firewall.drivers.linux.iptables_fwaas.IptablesFwaasDriver
enabled = True
</pre>

</div>
</div>

</div>

<div id="outline-container-9-4" class="outline-3">
<h3 id="sec-9-4">安装ovs插件</h3>
<div class="outline-text-3" id="text-9-4">


</div>

<div id="outline-container-9-4-1" class="outline-4">
<h4 id="sec-9-4-1">安装</h4>
<div class="outline-text-4" id="text-9-4-1">




<pre class="src src-sh">apt-get install openvswitch-switch neutron-plugin-openvswitch neutron-plugin-openvswitch-agent  
</pre>

</div>

</div>

<div id="outline-container-9-4-2" class="outline-4">
<h4 id="sec-9-4-2">网络配置</h4>
<div class="outline-text-4" id="text-9-4-2">


</div>

<div id="outline-container-9-4-2-1" class="outline-5">
<h5 id="sec-9-4-2-1">建立网桥</h5>
<div class="outline-text-5" id="text-9-4-2-1">

<p>ovs-vsctl add-br br-int
ovs-vsctl add-br br-ex
ovs-vsctl add-port br-ex eth0
</p></div>

</div>

<div id="outline-container-9-4-2-2" class="outline-5">
<h5 id="sec-9-4-2-2">编辑配置/etc/network/interfaces</h5>
<div class="outline-text-5" id="text-9-4-2-2">




<pre class="src src-sh">auto lo
iface lo inet loopback

auto eth1
iface eth0 inet static
        address 172.16.0.254
        netmask 255.255.255.0

auto eth0
iface eth0 inet manual
        up ifconfig $<span style="color: #2e8b57;">IFACE</span> 0.0.0.0 up
        down ifconfig $<span style="color: #2e8b57;">IFACE</span> down

auto br-ex
iface br-ex inet static
        address 192.168.150.8
        netmask 255.255.255.0
        gateway 192.168.8.1
        dns-nameservers 8.8.8.8
</pre>

<p>
****重启网络
</p>


<pre class="src src-sh">ifconfig eth0 0
/etc/init.d/networking restart
</pre>

</div>
</div>

</div>

<div id="outline-container-9-4-3" class="outline-4">
<h4 id="sec-9-4-3">编辑配置文件</h4>
<div class="outline-text-4" id="text-9-4-3">

<p>编辑/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini
</p>


<pre class="src src-sh">[securitygroup]
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Firewall driver for realizing neutron security group function.</span>
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
[ovs]
tenant_network_type = gre
tunnel_id_ranges = 1:1000
enable_tunneling = True
integration_bridge = br-int
tunnel_bridge = br-tun
local_ip = 172.16.0.254
</pre>

</div>
</div>

</div>

<div id="outline-container-9-5" class="outline-3">
<h3 id="sec-9-5">重启服务</h3>
<div class="outline-text-3" id="text-9-5">




<pre class="src src-sh"><span style="color: #cd6600;">cd</span> /etc/init.d/; <span style="color: #1c86ee;">for</span> i<span style="color: #1c86ee;"> in</span> $( ls neutron-* ); <span style="color: #1c86ee;">do</span> sudo service $<span style="color: #2e8b57;">i</span> restart; <span style="color: #1c86ee;">done</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-10" class="outline-2">
<h2 id="sec-10">Orchestration Server(Heat)安装</h2>
<div class="outline-text-2" id="text-10">


</div>

<div id="outline-container-10-1" class="outline-3">
<h3 id="sec-10-1">安装</h3>
<div class="outline-text-3" id="text-10-1">




<pre class="src src-sh">apt-get install heat-api heat-api-cfn heat-engine heat-api-cloudwatch
</pre>

</div>

</div>

<div id="outline-container-10-2" class="outline-3">
<h3 id="sec-10-2">创建数据库</h3>
<div class="outline-text-3" id="text-10-2">




<pre class="src src-sh">mysql -u root -p123456
mysql&gt; CREATE DATABASE heat;
mysql&gt; GRANT ALL PRIVILEGES ON heat.* TO <span style="color: #8b7355;">'heat'</span>@<span style="color: #8b7355;">'localhost'</span> IDENTIFIED BY <span style="color: #8b7355;">'heat'</span>;
mysql&gt; GRANT ALL PRIVILEGES ON heat.* TO <span style="color: #8b7355;">'heat'</span>@<span style="color: #8b7355;">'%'</span> IDENTIFIED BY <span style="color: #8b7355;">'heat'</span>;
</pre>

</div>

</div>

<div id="outline-container-10-3" class="outline-3">
<h3 id="sec-10-3">编辑配置文件</h3>
<div class="outline-text-3" id="text-10-3">

<p>/etc/heat/heat.conf
</p>


<pre class="src src-sh">verbose = True
<span style="color: #2e8b57;">log_dir</span>=/var/log/heat
rabbit_host = 172.16.0.254
rabbit_password = guest
[database]
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">The SQLAlchemy connection string used to connect to the database</span>
connection = mysql://heat:heat@172.16.0.254/heat
</pre>

<p>
/etc/heat/api-paste.ini
</p>


<pre class="src src-sh">[filter:authtoken]
paste.filter_factory = heat.common.auth_token:filter_factory
auth_host = 172.16.0.254
auth_port = 35357
auth_protocol = http
auth_uri = http://172.16.0.254:35357/v2.0
admin_tenant_name = service
admin_user = heat
admin_password = heat
</pre>

</div>

</div>

<div id="outline-container-10-4" class="outline-3">
<h3 id="sec-10-4">同步数据</h3>
<div class="outline-text-3" id="text-10-4">




<pre class="src src-sh">heat-manage db_sync
</pre>

</div>

</div>

<div id="outline-container-10-5" class="outline-3">
<h3 id="sec-10-5">创建用户和角色</h3>
<div class="outline-text-3" id="text-10-5">




<pre class="src src-sh">keystone user-create --name=heat --pass=heat --email=heat@126.com
keystone user-role-add --user=heat --tenant=service --role=admin
</pre>

</div>

</div>

<div id="outline-container-10-6" class="outline-3">
<h3 id="sec-10-6">创建服务和endpoint</h3>
<div class="outline-text-3" id="text-10-6">




<pre class="src src-sh">keystone service-create --name=heat --type=orchestration --description=<span style="color: #8b7355;">"Heat Orchestration API"</span>
keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:8004/v1/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:8004/v1/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.0.254:8004/v1/%<span style="color: #8b7355;">\(</span>tenant_id<span style="color: #8b7355;">\)</span>s

keystone service-create --name=heat-cfn --type=cloudformation --description=<span style="color: #8b7355;">"Heat CloudFormation API"</span>
keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:8000/v1 <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:8000/v1 <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.0.254:8000/v1
</pre>

</div>

</div>

<div id="outline-container-10-7" class="outline-3">
<h3 id="sec-10-7">重启服务</h3>
<div class="outline-text-3" id="text-10-7">




<pre class="src src-sh"><span style="color: #cd6600;">cd</span> /etc/init.d/; <span style="color: #1c86ee;">for</span> i<span style="color: #1c86ee;"> in</span> $( ls heat-* ); <span style="color: #1c86ee;">do</span> sudo service $<span style="color: #2e8b57;">i</span> restart; <span style="color: #1c86ee;">done</span>
</pre>

</div>

</div>

<div id="outline-container-10-8" class="outline-3">
<h3 id="sec-10-8">创建openrc</h3>
<div class="outline-text-3" id="text-10-8">




<pre class="src src-sh">cat &gt; /root/openrc &lt;&lt; _EOF_
<span style="color: #ffa54f;">ENABLED_SERVICES+=,heat,h-api,h-api-cfn,h-api-cw,h-eng</span>
<span style="color: #ffa54f;">CEILOMETER_BACKEND=mongo</span>
<span style="color: #ffa54f;">_EOF_</span>
<span style="color: #cd6600;">echo</span> <span style="color: #8b7355;">'source /root/openrc'</span> &gt;&gt; /root/.bashrc
<span style="color: #cd6600;">source</span> /root/openrc
</pre>

<p>
配置了ENABLED_SERVICES才能用heat命令
</p></div>

</div>

<div id="outline-container-10-9" class="outline-3">
<h3 id="sec-10-9">创建和管理stacks</h3>
<div class="outline-text-3" id="text-10-9">




<pre class="src src-sh">wget https://raw.github.com/openstack/heat-templates/master/cfn/F17/WordPress_Composed_Instances.template
glance image-create --name F17-x86_64-cfntools --disk-format qcow2 --container-format bare --is-public True --copy-from http://fedorapeople.org/groups/heat/prebuilt-jeos-images/F17-x86_64-cfntools.qcow2
nova keypair-add heat_key &gt; heat_key.priv
chmod 600 heat_key.priv
heat stack-create wordpress --template-file=WordPress_Composed_Instances.template --parameters=<span style="color: #8b7355;">"DBUsername=wp;DBPassword=wp;KeyName=userkey;LinuxDistribution=F17"</span>
heat stack-list
</pre>

<p>
PS:对heat还没有研究，创建stack是网上找的
</p></div>
</div>

</div>

<div id="outline-container-11" class="outline-2">
<h2 id="sec-11">Metering/Monitoring Server（Ceilometer）安装</h2>
<div class="outline-text-2" id="text-11">


</div>

<div id="outline-container-11-1" class="outline-3">
<h3 id="sec-11-1">安装</h3>
<div class="outline-text-3" id="text-11-1">

<p>安装服务
</p>


<pre class="src src-sh">apt-get install ceilometer-api ceilometer-collector ceilometer-agent-central python-ceilometerclient ceilometer-agent-compute
</pre>

<p>
安装MongoDB Orchestration 服务使用数据库来存储信息，此示例使用MongoDB数据库
</p>


<pre class="src src-sh">apt-get install mongodb
</pre>

</div>

</div>

<div id="outline-container-11-2" class="outline-3">
<h3 id="sec-11-2">创建数据库</h3>
<div class="outline-text-3" id="text-11-2">

<p>运行mongo命令报错couldn't connect to server 127.0.0.1:27017 at src/mongo/shell/mongo.js:145，运行mongod -dbpath=/data/db解决。
</p>


<pre class="src src-sh">mongo
&gt; use ceilometer
&gt; db.addUser( { user: <span style="color: #8b7355;">"ceilometer"</span>,
<span style="color: #cd6600;">pwd</span>: <span style="color: #8b7355;">"ceilometer"</span>,
roles: [ <span style="color: #8b7355;">"readWrite"</span>, <span style="color: #8b7355;">"dbAdmin"</span> ]
} )
</pre>

</div>

</div>

<div id="outline-container-11-3" class="outline-3">
<h3 id="sec-11-3">修改配置文件</h3>
<div class="outline-text-3" id="text-11-3">

<p>修改/etc/ceilometer/ceilometer.conf
</p>


<pre class="src src-sh">[database]
...
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">The SQLAlchemy connection string used to connect to the</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">database (string value)</span>
connection = mongodb://ceilometer:CEILOMETER_DBPASS@controller:27017/ceilometer
[publisher_rpc]
...
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Secret value for signing metering messages (string value)</span>
metering_secret = wchunx
...
[keystone_authtoken]
auth_host = 172.16.0.254
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = ceilometer
admin_password = ceilometer
</pre>

</div>

</div>

<div id="outline-container-11-4" class="outline-3">
<h3 id="sec-11-4">创建用户，角色，服务和endpoint</h3>
<div class="outline-text-3" id="text-11-4">




<pre class="src src-sh">keystone user-create --name=ceilometer --pass=CEILOMETER_PASS --email=ceilometer@126.com
keystone user-role-add --user=ceilometer --tenant=service --role=admin

keystone service-create --name=ceilometer --type=metering --description=<span style="color: #8b7355;">"Ceilometer Metering Service"</span>
keystone endpoint-create <span style="color: #8b7355;">\</span>
--service-id=the_service_id_above <span style="color: #8b7355;">\</span>
--publicurl=http://172.16.0.254:8777/ <span style="color: #8b7355;">\</span>
--internalurl=http://172.16.0.254:8777/ <span style="color: #8b7355;">\</span>
--adminurl=http://172.16.254:8777/
</pre>

</div>

</div>

<div id="outline-container-11-5" class="outline-3">
<h3 id="sec-11-5">重启服务</h3>
<div class="outline-text-3" id="text-11-5">




<pre class="src src-sh"><span style="color: #cd6600;">cd</span> /etc/init.d/; <span style="color: #1c86ee;">for</span> i<span style="color: #1c86ee;"> in</span> $( ls ceilometer-* ); <span style="color: #1c86ee;">do</span> sudo service $<span style="color: #2e8b57;">i</span> restart; <span style="color: #1c86ee;">done</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-12" class="outline-2">
<h2 id="sec-12">安装horizon</h2>
<div class="outline-text-2" id="text-12">




<pre class="src src-sh">apt-get install memcached libapache2-mod-wsgi openstack-dashboard
apt-get remove --purge openstack-dashboard-ubuntu-theme
</pre>

<p>
编辑/etc/openstack_dashboard/local/local_settings.py设置
</p>


<pre class="src src-sh"><span style="color: #8b7355;">'enable_firewall'</span> = True
</pre>

<p>
重启apache2
</p>


<pre class="src src-sh">/etc/init.d/apache2 restart
</pre>

<p>
浏览器访问192.168.150.9/horizon.
</p></div>

</div>

<div id="outline-container-13" class="outline-2">
<h2 id="sec-13">参考资料</h2>
<div class="outline-text-2" id="text-13">


</div>

<div id="outline-container-13-1" class="outline-3">
<h3 id="sec-13-1">heat</h3>
<div class="outline-text-3" id="text-13-1">

<p><a href="http://openstack.redhat.com/Deploy_an_application_with_Heat">http://openstack.redhat.com/Deploy_an_application_with_Heat</a>
<a href="https://answers.launchpad.net/heat/+question/238879">https://answers.launchpad.net/heat/+question/238879</a>
<a href="http://digitalsanctum.com/2013/05/01/how-to-install-openstack-heat/">http://digitalsanctum.com/2013/05/01/how-to-install-openstack-heat/</a>
<a href="http://docs.openstack.org/developer/heat/getting_started/on_devstack.html">http://docs.openstack.org/developer/heat/getting_started/on_devstack.html</a>
</p></div>
</div>

</div>

<div id="outline-container-14" class="outline-2">
<h2 id="sec-14">其他</h2>
<div class="outline-text-2" id="text-14">



</div>
</div>
